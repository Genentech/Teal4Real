<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Data Upload • Teal4Real</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.4.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.4.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Data Upload">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">Teal4Real</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.0.6</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/Basic_usage_examples.html">Basic usage examples</a></li>
    <li><a class="dropdown-item" href="../articles/data_upload.html">Data Upload</a></li>
  </ul>
</li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">



<script src="data_upload_files/accessible-code-block-0.0.1/empty-anchor.js"></script><div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Data Upload</h1>
            
      

      <div class="d-none name"><code>data_upload.Rmd</code></div>
    </div>

    
    
<blockquote>
<p>This article describes a possible way to use Teal4Real on your own dataset by uploading the data to Posit Connect. However, this is not absolutely necessary - you may also just call some data-generating R code from within <code>Teal4Real_userdata.R</code> and leave caching to Teal4Real by setting <code>update_cache = TRUE</code> in <code>Teal4Real_userconfig.R</code>. as described in the previous article. This will mean that your data is generated the first time the app is run, and then cached for future use.</p>
</blockquote>
<div class="section level2">
<h2 id="how-to-use-teal4real-on-your-own-analysis-dataset">How to use Teal4Real on your own analysis dataset!<a class="anchor" aria-label="anchor" href="#how-to-use-teal4real-on-your-own-analysis-dataset"></a>
</h2>
<p>If you want to use Teal4Real on your own analysis dataset, you’ll have to look through all the files with “user” in the filename (<code>Teal4Real_userconfig.R</code> and <code>Teal4Real_userdata.R</code>), and follow the explanations in the comments.</p>
<p><img src="../reference/figures/different_dataset_01.png" id="id" class="class" padding="30px" style="width:70.0%;height:50.0%"></p>
</div>
<div class="section level2">
<h2 id="step-1-connecting-to-the-data">Step 1: Connecting to the Data!<a class="anchor" aria-label="anchor" href="#step-1-connecting-to-the-data"></a>
</h2>
<p>Create a new script called something along the lines of create_context. In this script we will include how to connect to your data using the Rochedata package. (Please note there are other methods to do this, however this one is one of the easiest).</p>
<p>In this step we must create the data as an object. You must source this in the Teal4Real_userdata.R file like this: source(“create_context.R”).</p>
<p>Here is an example, please replace with your own ARD Schema name (if you have one) and call the edm object a name of your choice.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ard_schema_name_edm</span> <span class="op">&lt;-</span> <span class="st">"flatiron_edm_ansclc_ard_2023_11"</span> </span>
<span><span class="va">schema_name_edm</span> <span class="op">&lt;-</span> <span class="st">"flatiron_edm_ansclc_sdm_2023_11"</span>  <span class="co">#Replace with own Schema name</span></span>
<span></span>
<span><span class="va">edm</span> <span class="op">&lt;-</span> <span class="fu">RocheData</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/RocheData/man/get_data.html" class="external-link">get_data</a></span><span class="op">(</span>data <span class="op">=</span> <span class="st">"flatiron_edm_ansclc"</span><span class="op">)</span> <span class="co">#Assigning the data to Object called edm</span></span>
<span><span class="co">#&gt; → Connecting to MDHmeta API and saving to session cache...</span></span>
<span><span class="co">#&gt; → Getting MDH datasets info...</span></span>
<span><span class="co">#&gt; <span style="color: #00BB00;">✔</span> <span style="color: #00BB00;">Done.</span></span></span>
<span><span class="co">#&gt; <span style="color: #00BB00;">✔</span> <span style="color: #00BB00;">MDHmeta connections saved in the session cache.</span></span></span>
<span><span class="co">#&gt; → Reading connections from the package config file...</span></span>
<span><span class="co">#&gt; <span style="color: #00BB00;">✔</span> <span style="color: #00BB00;">Done.</span></span></span>
<span><span class="va">edm</span><span class="op">$</span><span class="fu">connect</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; Connecting to the database: 'flatiron_edm_ansclc'...</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="step-2-set-up-your-cohort">Step 2: Set Up Your Cohort!<a class="anchor" aria-label="anchor" href="#step-2-set-up-your-cohort"></a>
</h2>
<p>We now want to personalize this Teal4Real app to the cohort you are interested in. Here you will work on the <code>Teal4Real_userconfig.R</code> file and define your endpoints.</p>
<p>Let’s create a new script called something along the lines of create_cohort. Here we will create our cohort as a function.<br>
Here we will turn our data into one table by left joining any variables.</p>
<p>This is a customised file where you create your cohort!</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">get_broad_cohort</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">db_obj</span>, <span class="va">schema_name</span>, <span class="va">ard_schema_name</span>, <span class="va">use_reporteddate</span> <span class="op">=</span> <span class="cn">T</span><span class="op">)</span></span>
<span>    </span>
<span>  <span class="va">create_tbl</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">database_schema</span>, <span class="va">table_name</span>, <span class="va">.db</span>, <span class="va">...</span><span class="op">)</span> <span class="op">{</span></span>
<span>        <span class="fu">tbl</span><span class="op">(</span><span class="va">.db</span>, <span class="fu">in_schema</span><span class="op">(</span><span class="va">database_schema</span>, <span class="va">table_name</span><span class="op">)</span><span class="op">)</span></span>
<span>      <span class="op">}</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="step-3-set-up-your-pin">Step 3: Set up your Pin!<a class="anchor" aria-label="anchor" href="#step-3-set-up-your-pin"></a>
</h2>
<p>This is an optional step however may help separate the whole data process from the app logic. This may substantially improve the run time of the app.</p>
<ol style="list-style-type: decimal">
<li><p>First create a markdown file in an <code>inst</code> folder. This will serve as a scheduled report for uploading the data to a pin on Posit Connect.</p></li>
<li><p>Put all the files with functions that are used to create the cohort data in the <code>inst</code> folder and source these files in the markdown file. <img src="../reference/figures/inst_files_demo.png" id="id" class="class" padding="30px" style="width:70.0%;height:50.0%"></p></li>
<li><p>In markdown file: call the following librarys magrittr and pins, and source your “create_context.R” and “create_cohorts.R” files.</p></li>
</ol>
<p>Also call the main data function, connect to board and save the output to a pin.</p>
<p>Here is an example of what your markdown file should look like (where Impower_data is my pin name): In this example I have a separate pin for the data and the data date (extracted from the schema).</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># cut_date &lt;- pull_cut_date("flatiron_edm_ansclc_sdm_")</span></span>
<span><span class="co"># ard_schema_name_edm &lt;- paste0("flatiron_edm_ansclc_ard_", cut_date)</span></span>
<span><span class="co"># schema_name_edm &lt;- paste0("flatiron_edm_ansclc_sdm_", cut_date)</span></span>
<span><span class="co">#  board &lt;- pins::board_connect(</span></span>
<span><span class="co">#   auth   = "manual",</span></span>
<span><span class="co">#   server =  "https://connect.apollo.roche.com/",</span></span>
<span><span class="co">#   key = Sys.getenv("CONNECT_API_KEY")</span></span>
<span><span class="co"># )</span></span>
<span><span class="co">#  data_date &lt;-  pins::pin_read(board,"RAJAR6/Impower_data_date")</span></span>
<span><span class="co">#  if(data_date!=cut_date){</span></span>
<span><span class="co">#     cohort_data &lt;- tryCatch({</span></span>
<span><span class="co">#     get_broad_cohort(</span></span>
<span><span class="co">#     db_obj = edm,</span></span>
<span><span class="co">#     schema_name = schema_name_edm,</span></span>
<span><span class="co">#     ard_schema_name = ard_schema_name_edm,</span></span>
<span><span class="co">#     use_reporteddate = T</span></span>
<span><span class="co">#   ) %&gt;%</span></span>
<span><span class="co">#     include("Met dx in 2016 or later", year(met_dx_date) &gt;= 2016)</span></span>
<span><span class="co"># },</span></span>
<span><span class="co"># error = function(e) {</span></span>
<span><span class="co">#   e</span></span>
<span><span class="co"># })</span></span>
<span><span class="co"># if (!inherits(cohort_data,"error")){</span></span>
<span><span class="co">#   board %&gt;% pins::pin_write(</span></span>
<span><span class="co">#     x = cohort_data,</span></span>
<span><span class="co">#     name = "RAJAR6/Impower_data")</span></span>
<span><span class="co">#   board %&gt;% pins::pin_write(</span></span>
<span><span class="co">#     x = cut_date,</span></span>
<span><span class="co">#     name = "RAJAR6/Impower_data_date")</span></span>
<span><span class="co">#  }</span></span>
<span><span class="co">#  }</span></span></code></pre></div>
<ol start="4" style="list-style-type: decimal">
<li>Now in your <code>Teal4Real_userdata.R</code> file add this syntax code to pull the data from the pin.</li>
</ol>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">cohort_query</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/message.html" class="external-link">message</a></span><span class="op">(</span><span class="st">"Pulling data from pin..."</span><span class="op">)</span></span>
<span>    <span class="va">board</span> <span class="op">&lt;-</span> <span class="fu">pins</span><span class="fu">::</span><span class="fu">board_connect</span><span class="op">(</span></span>
<span>        auth   <span class="op">=</span> <span class="st">"manual"</span>,</span>
<span>        server <span class="op">=</span>  <span class="st">"https://connect.apollo.roche.com/"</span>,</span>
<span>        key <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Sys.getenv.html" class="external-link">Sys.getenv</a></span><span class="op">(</span><span class="st">"CONNECT_API_KEY"</span><span class="op">)</span></span>
<span>    <span class="op">)</span></span>
<span>    <span class="fu">pins</span><span class="fu">::</span><span class="fu">pin_read</span><span class="op">(</span><span class="va">board</span>, <span class="st">"RAJAR6/Impower_data"</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<ol start="5" style="list-style-type: decimal">
<li>To schedule the report automatically you need to deploy the report to Posit Connect with source code and schedule it in a custom way. Here you may want to custom it to Use the blue button in the top right to deploy the r markdown. Follow the steps and ensure that you the markdown with source code.</li>
</ol>
<p><img src="../reference/figures/blue_deploy_icon.png" id="id" class="class" padding="30px" style="width:70.0%;height:50.0%"></p>
<p>First time, it may crash. It is important to still deploy it even if it crashes. The reaosn for this will usually be due to needing to input environment variables. So once deployed,on Posit Connect directly, you should see the Vars feature where you can input your username and password.</p>
<p>Here you will also find the Schedule feature where you can schedule how often you want this markdown to knit in the background, so you do not have to carry out this step. (I have chosen to do this daily). Please note, after making changes to your cohort, it is important you knit this markdown before you run your app, so that the changes are made.</p>
<p><img src="../reference/figures/positconnect_ss.png" id="id" class="class" padding="30px" style="width:70.0%;height:70.0%"></p>
<p><img src="../reference/figures/scheduling.png" id="id" class="class" padding="30px" style="width:70.0%;height:50.0%"></p>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Michael Bretscher, Daniel Sabanes Bove.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.1.</p>
</div>

    </footer>
</div>





  </body>
</html>
